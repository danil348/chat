import { auth } from "@/firebase";
import { signInWithEmailAndPassword } from "firebase/auth";
import { useCallback, useContext, useState } from "react";
import { AuthContext } from "../../context/AuthContext";
import useLoginModal from "../../hooks/useLoginModal";
import useRegisterModal from "../../hooks/useRegisterModal";
import Input from "../Input/Input";
import Modal from "../Modal/Modal";

const LoginModal = () => {

  const loginModal = useLoginModal()
  const registerModal = useRegisterModal()

  const [email, setEmail] = useState<string>('')
  const [password, setPassword] = useState<string>('')
  const [isLoading, setIsLoading] = useState<boolean>(false)

  const userContext = useContext(AuthContext)

  const onSubmit = useCallback(async () => {
		try {
			setIsLoading(true)

      const res = await signInWithEmailAndPassword(auth, email, password);

      userContext.setCurrentUser({
        name: res.user.displayName,
        email: res.user.email,
        uid: res.user.uid
      })

			loginModal.onClose()
		} catch (error) {
			console.log("üöÄ ~ file: LoginModal.tsx:16 ~ onSubmit ~ error:", error)
		} finally {
			setIsLoading(false)
		}
	}, [email, loginModal, password, userContext])

  const onToggle = useCallback(() => {
    if(isLoading){
      return
    }

    loginModal.onClose()
    registerModal.onOpen()
  }, [isLoading, loginModal, registerModal])

  const bodyContent = (
    <div className="form__content">
      <Input
      label={true}
      warning={true}
      labelContent="–∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã"
      placeholder=""
      onChange={(e) => setEmail(e.target.value)}
      value={email}
      disabled={isLoading}
      />
      <Input
        label={true}
        warning={true}
        labelContent="–ü–∞—Ä–æ–ª—å"
        placeholder=""
        type="password"
        onChange={(e) => setPassword(e.target.value)}
        value={password}
        disabled={isLoading}
      />
    </div>
  )

  const footerContent = (
    <div className="form__footerContent">
      <p>–ù—É–∂–Ω–∞ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å?
        <span className="" onClick={onToggle} >
          –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </span>
      </p>
    </div>
  )

  return (
    <Modal
      disabled={isLoading}
      isOpen={loginModal.isOpen}
      title="–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!"
      text="–ú—ã —Ç–∞–∫ —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞!"
      actionLabel="–í—Ö–æ–¥"
      onClose={loginModal.onClose}
      onSubmit={onSubmit}
      body={bodyContent}
      footer={footerContent}
    />
  )
}

export default LoginModal